DECLARE @COD VARCHAR(MAX);
DECLARE @DTINI VARCHAR(8);
DECLARE @DTFIM VARCHAR(8);
DECLARE @FECHA VARCHAR(8);

-- SET @COD = N'005859,005863,005869,005904,005927,005942,005947,005954,005966,005989,005999,006005,006021,006022,006024,006029,006088,006090,006168,006169,006170,006171,006172,006173,006174,006176,006194,006197,006204,006673,006699,006750,006751,006803,006867,006911,006914,006957,007289,007291,007292,007298,007308,007309,007311,007313,007315,007318,007319,007324,007325,007327,007328,007342,007345,007346,007349,007473,007660,007664,007666,007667,007668,007669,007670,007671,007672,007673,007674,007675,007679,007712,008055,008128,008130,008140,008144,008154,008174,008176,008177,008178,008185,008187,008190,008193,008195,008196,008197,008198,008199,008200,008201,008202,008234,008235,008237,008238,008240,008242,008256,008262,008264,008267,008289,008297,008303,008307,008310,008361,008402,008405,008407,008408,008409,008410,008432,008476,008530,008532,008538,008565,008567,008657,008658,008995,008998,009016,009337,009339,009345,009375,009376,009377,009378,009379,009380,009485,009486,009606,009651,009665,009772,009773,009774,009776,009793,010176,010177,010184,010452,010462,010519,010796,010797,010798,010799,010801,010802,010810,010817,010818,010824,010832,010833,010842,010850,010852,010860,010863,010864,010870,010873,010879,010880,010882,010885,010887,010931,011176,011178,011182,011199,011201,011214,011298,011320,011351,011469,011470,011471,011579,011615,011617,011618,011622,011679,011840,011841,012045,012046,012065,012066,012067,012068,012069,012070,012071,012072,012073,012074,012075,012077,012078,012079,012080,012128,012134,012143,012150,012158,012249,012250,012300,012329,012392,012448,012457,012517,012518,012522,012523,012524,012529,012530,012540,012591,012787,012788,012964,012966,012967,012977,012978,012981,012984,012986,012990,012993,013105,013106,013111,013112,013118,013119,013121,013122,013123,013126,013128,013167,013169,013177,013208,013213,013219,013235,013237,013239,013240,013241,013243,013265,013266,013274,013331,013332,013333,013334,013335,013336,013337,013338,013339,013341,013342,013376,013377,013378,013380,013382,013390,013391,013402,013404,013405,013406,013408,013409,013414,013415,013420,013421,013422,013423,013427,013428,013431,013433,013457,013460,013466,013480,013481,013482,013483,013492,013496,013501,013502,013503,013505,013507,013519,013520,013523,013947,013948,013949,013954,013957,013994,013996,013998,014001,014003,014011,014013,014101,014138,014565,014984,015140,015143,015597,015600,015602,015603,015606,015608,015609,015615,015617,015619,015624,015625,015627,015628,015630,015631,015632,015633,015634,015635,015680,015731,015951,015953,015958,015982,015996,015997,015998,016005,016007,016032,016035,016036,016037,016038,016192,016193,016194,016375,016435,016436,016437,016438,016452,016479,016483,016494,016497,016498,016499,016501,016503,016504,016505,016510,016511,016606,016609,016616,016712,016716,016769,016826,016843,016844,016845,016976,016977,017014,017015,017016,017017,017021,017024,017026,017057,017123,017127,017149,017151,017152,017153,017154,017155,017156,017159,017163,017164,017175,017250,017256,017271,017272,017311,017325,017330,017350,017351,017354,017405,017406,017410,017413,017416,017417,017419,017420,017422,017423,017424,017425,017426,017427,017429,017430,017431,017432,017434,017436,017438,017440,017441,017442,017443,017444,017453,017454,017455,017465,017654,017655,017657,017658,017661,017662,017679,017680,017685,017704,017710,017913,017914,017915,017917,017918,017920,017922,017923,017997,018103,018104,018105,018106,018107,018245,018257,018261,018282,018310,018312,018313,018315,018316,018317,018318,018319,018320,018321,018322,018333,018334,018336,018341,018361,018362,018363,018380,018385,018386,018387,018388,018389,018390,018391,018392,018393,018394,018395,018396,018399,018401,018402,018412,018413,018414,018420,018423,018426,018427,018434,018525,018527,018528,018529,018533,018534,018535,018536,018537,018538,018539,018540,018541,018558,018597,018598,018599,018600,018601,018678,018723,018792,018935,018940,018941,018948,019069,019085,019402,019547,019550,019905,019957,019959,019961,019965,019966,019968,019969,019970,019971,019973,019974,019976,019977,019979,019980,019985,019986,019987,019988,020025,020027,020041,020042,020044,020065,020145,020146,020147,020149,020195,020196,020200,020226,020409,020424,020425,020439,020440,020472,020474,020653,020663,021994,022469,022472,022571,022573,022584,022668,022669,022671,022672,022673,022674,022675,022678,022679,022681,022682,022683,022684,022687,022689,022692,022696,022697,022698,022700,022702,022728,022735,022740,022744,022887,022888,022907,022909,022916,022922,022930,022958,022972,022973,022980,022984,022995,023006,023009,023010,023013,023015,023016,023202,023221,023535,023565,023602,023604,023683,023684,023685,023686,023688,023689,023693,023694,023702,023705,023706,023707,023711,023713,023714,023718,023721,023722,023725,023726,023727,023728,023729,023730,023731,023732,023733,023734,023735,023736,023737,023738,023739,023740,023741,023742,023743,023744,023745,023776,023804,023807,023848,023849,023850,023851,023852,023854,023887,023888,023889,023891,023892,023893,023894,023895,023896,023897,023898,023899,023902,023903,023904,023905,023907,023908,023910,023911,023913,023914,023916,023917,023920,023921,023922,023924,023925,023928,023930,023932,023933,023936,023937,023960,023964,023965,023966,023998,024001,024002,024004,024077,024079,024081,024082,024088,024093,024133,024228,024293,024295,024301,024346,024347,024348,024349,024350,024351,024352,024353,024354,024475,024485,024486,024521,024543,024548,024576,024577,024707,024708,024725,024726,024745,024749,024760,024762,024772,024775,024781,024888,024892,024903,024904,024977,024980,024981,024983,024984,025120,025121,025138,025493,025550,025551,025793,025825,025826,025827,025828,025829,026120,026124,026125,026126,026127,026139,026272,026275,026276,026277,026278,026320,026326,026327,026328,026330,026331,026333,026334,026335,026336,026337,026338,026587,026588,026597,026684,026685,026686,026687,026695,026698,026700,026701,026703,026704,026707,026708,026745,026747,026772,026773,026774,026780,027036,027131,027147,027187,027219,027221,027222,027228,027229,027231,027232,027233,027235,027564,027567,027743,027814,027830,028024,028025,028026,028027,028028,028029,028030,028031,028032,028033,028034,028036,028037,028038,028039,028043,028044,028046,028047,028051,028052,028053,028054,028055,028056,028057,028058,028059,028060,028063,028081,028171,028175,028183,028188,028189,028200,028201,028208,028229,028230,028269,028315,028316,028317,028318,028345,028346,028348,028349,028351,028353,028355,028356,028359,028361,028365,028371,028372,028379,028381,028384,028387,028392,028394,028398,028405,028414,028432,028435,028436,028437,028574,028578,028591,028612,028631,028665,028666,028723,028724,028725,028726,028727,028728,028771,028931,028932,028933,028935,028936,028937,028938,028940,028941,028946,028947,028949,028953,028954,028956,028958,028959,028961,028963,028964,028966,028969,028970,028974,028986,028987,029007,029008,029009,029010,029011,029012,029018,029019,029020,029021,029022,029024,029025,029027,029028,029030,029031,029034,029038,029039,029040,029041,029044,029046,029579,029580,029581,029588,029590,029591,029592,029594,029596,029597,029599,029600,029602,029603,029604,029605,029607,029609,029611,029612,029633,029927,029950,029959,029965,029971,029973,029974,029976,029978,029989,029990,029991,029992,029993,030021,030040,030074,030075,030076,030077,030082,030083,030084,030085,030086,030087,030089,030090,030091,030092,030093,030094,030095,030098,030101,030102,030103,030104,030105,030106,030107,030108,030109,030110,030112,030113,030115,030116,030117,030124,030172,030174,030175,030176,030177,030178,030179,030180,030181,030184,030185,030195,030196,030200,030201,030204,030205,030206,030207,030208,030209,030210,030211,030212,030213,030224,030226,030227,030231,030232,030241,030242,030243,030247,030251,030252,030253,030254,030255,030256,030257,030260,030262,030263,030264,030265,030266,030269,030270,030271,030272,030274,030275,030277,030342,031071,031074,031076,031115,031356,031359,031360,031411,031413,031415,031416,031417,031421,031422,031423,031424,031425,031427,031428,031634,031636,031726,031729,031731,031735,031736,031745,031755,031762,031764,031765,031766,031767,031768,031770,031772,031773,031774,031775,031776,031777,031922,031979,031985,032007,032008,032009,032010,032013,032014,032048,032053,032054,032114,032139,032140,032157,032158,032160,032161,032180,032205,032206,032258,032359,032389,032390,032438,032439,032440,032588,032593,032594,032628,032653,032666,032673,032674,032680,032735,032737,032738,032739,032740,032747,032751,032755,032756,032757,032759,032760,032761,032762,032763,032792,032798,032816,032818,032819,032821,032822,032823,032825,032826,032827,032828,032829,032830,032831,032832,032834,032836,032838,032839,032840,032933,032972,032975,032977,032990,033013,033030,033033,033034,033036,033037,033039,033040,033041,033042,033043,033045,033050,033051,033052,033053,033054,033055,033056,033070,033072,033073,033075,033076,033079,033081,033085,033086,033115,033116,033139,033272,033277,033311,033313,033314,033315,033316,033317,033318,033389,033399,033403,033406,033420,033422,033441,033449,033451,033456,033457,033459,033460,033461,033462,033463,033464,033465,033466,033467,033468,033469,033470,033471,033472,033473,033474,033475,033476,033479,033480,033481,033482,033483,033484,033485,033486,033487,033488,033489,033511,033512,033513,033514,033525,033527,033528,033529,033530,033531,033532,033533,033534,033535,033537,033544,033546,033561,033562,033563,033565,033566,033572,033574,033578,033618,033619,033620,033623,033624,033655,033678,033679,033690,033719,033722,033723,033724,033725,033726,033728,033732,033733,033739,033750,033752,033754,033756,033757,033760,033777,033784,033785,033786,033788,033803,033859,033860,033861,033897,033906,033907,033908,033910,033911,033912,033913,033914,033915,033923,033924,033925,033926,033927,033928,033929,033932,033933,033934,033936,033938,033940,033941,033949,033950,033951,033952,033953,033954,033956,033996,033997,034005,034011,034017,034019,034022,034057,034058,034060,034063,034065,034066,034067,034068,034069,034070,034083,034199,034285,034286,034288,034291,034293,034298,034299,034300,034304,034309,034337,034341,034343,034344,034347,034365,034368,034372,034379,034381,034382,034386,034395,034414,034418,034420,034421,034426,034434,034435,034455,034456,034458,034462,034463,034470,034473,034474,034480,034481,034482,034483,034484,034485,034486,034488,034493,034507,034509,034510,034513,034515,034516,034517,034518,034537,034538,034555,034576,034578,034593,034594,034595,034611,034612,034613,034616,034617,034622,034629,034630,034631,034632,034633,034634,034635,034636,034638,034639,034640,034641,034642,034643,034644,034647,034648,034679,034680,034681,034682,034683,034684,034689,034691,034692,034693,034695,034696,034697,034698,034699,034703,034715,034733,034742,034745,034747,034748,034749,034750,034751,034754,034755,034756,034757,034759,034760,034761,034762,034763,034764,034765,034767,034768,034771,034772,034773,034776,034777,034778,034780,034781,034782,034783,034784,034785,034786,034787,034788,034790,034791,034792,034793,034795,034796,034797,034798,034812,034815,034816,034819,034820,034826,034838,034839,034840,034841,034851,034852,034854,034879,034886,034925,034947,034961,034963,034965,034967,034968,034977,034978,034979,034980,034982,034983,034986,034987,034988,034989,034990,034993,034994,034995,034996,034997,034999,035000,035001,035003,035005,035011,035014,035015,035016,035018,035020,035025,035026,035027,035028,035029,035030,035031,035032,035037,035041,035042,035043,035054,035113,035114,035116,035119,035120,035122,035124,035125,035127,035129,035131,035132,035141,035142,035145,035148,035158,035159,035160,035161,035173,035177,035186,035191,035193,035194,035198,035201,035225,035226,035227,035228,035229,035230,035231,035234,035236,035237,035240,035242,035243,035245,035317,035320,035321,035325,035326,035327,035329,035332,035335,035337,035346,035349,035351,035354,035374,035377,035378,035477,035478,035479,035480,035481,035482,035484,035494,035499,035500,035501,035502,035507,035511,035512,035517,035519,035521,035524,035530,035537,035538,035539,035540,035542,035546,035547,035548,035550,035551,035552,035560,035561,035564,035595,035596,035629,035630,035631,035632,035633,035634,035637,035642,035647,035649,035679,035680,035681,035682,035683,035686,035692,035855,035858,035861,035862,035867,035872,035873,035874,035875,035877,035878,035883,035884,035888,035892,035894,035897,035906,035908,035911,035915,035916,035917,035918,035919,035920,035921,035922,035924,035927,035928,035929,035930,035931,035932,035933,035934,035935,035938,035971,035972,035984,035994,036000,036002,036099,036100,036101,036102,036104,036106,036107,036108,036109,036110,036111,036112,036154,036156,036157,036158,036161,036162,036164,036165,036207,036210,036212,036213,036221,036265,036276,036282,036285,036286,036287,036288,036290,036291,036292,036296,036303,036316,036317,036461,036482,036483,036511,036512,036513,036514,036515,036517,036518,036520,036521,036523,036524,036531,036532,036533,036536,036537,036547,036550,036552,036555,036559,036567,036569,036570,036572,036573,036575,036576,036577,036578,036579,036616,036617,036621,036627,036640,036641,036643,036645,036646,036649,036650,036651,036655,036660,036672,036673,036677,036678,036679,036680,036681,036682,036683,036684,036685,036686,036687,036688,036690,036691,036693,036694,036696,036697,036699,036700,036701,036702,036703,036704,036705,036706,036707,036708,036710,036711,036712,036713,036714,036715,036716,036717,036718,036719,036720,036721,036722,036723,036724,036725,036729,036730,036736,036740,036742,036743,036744,036748,036752,036753,036756,036757,036758,036759,036761,036762,036763,036764,036765,036767,036768,036769,036770,036771,036772,036776,036777,036784,036785,036786,036787,036788,036789,036790,036791,036792,036795,036796,036797,036799,036800,036801,036802,036820,036822,036825,036830,036831,036832,036833,036839,036843,036868,036869,036870,036871,036872,036873,036874,036875,036876,036877,036879,036880,036881,036882,036883,036886,036887,036888,036904,036905,036955,036957,036958,036961,036971,036972,036974,036976,036977,036978,036985,036986,036987,037005,037008,037010,037011,037012,037013,037014,037015,037029,037045'
SET @COD = N'036616         '
SET @DTINI = '20200301'
SET @DTFIM = '20200331'
SET @FECHA = '20200229'

SELECT	D1_COD,
		IIF(SUM(QTD)>0
		   ,SUM(CUSTO)/SUM(QTD)
		   ,SUM(IIF(ORIGEM!='SD2',CUSTO,0))
		   		/SUM(IIF(ORIGEM!='SD2',QTD,0))
		   ) Medio,
		
		--  PARA ANALISE		
		--    SUM(IIF(ORIGEM!='SD2',CUSTO,0)),
		--    SUM(IIF(ORIGEM!='SD2',QTD,0)),
		
		(SELECT MAX(B9_VINI1/B9_QINI) FROM SB9010 A WHERE A.D_E_L_E_T_='' AND A.B9_COD=T1.D1_COD AND A.B9_QINI>0 AND A.B9_DATA=@DTFIM) CUSTO_FECHADO, 
		(SELECT MAX(B9_VINI1/B9_QINI) FROM SB9010 A WHERE A.D_E_L_E_T_='' AND A.B9_COD=T1.D1_COD AND A.B9_QINI>0 AND A.B9_DATA=@FECHA) CUSTO_INICIAL
FROM 
(
-- NOTAS DE ENTRADA
SELECT 'SD1' ORIGEM,D1_COD,SUM(D1_CUSTO) CUSTO, SUM(D1_QUANT) QTD
FROM SD1010 A (NOLOCK) 
INNER JOIN SF4010 B ON B.D_E_L_E_T_='' AND B.F4_CODIGO=A.D1_TES AND B.F4_ESTOQUE='S'
WHERE	A.D_E_L_E_T_=''
		AND A.D1_DTDIGIT BETWEEN @DTINI AND @DTFIM
		AND A.D1_TIPO NOT IN ('B','D')
		AND A.D1_TES!=''
		AND CHARINDEX(RTRIM(A.D1_COD),@COD) > 0
		AND (A.D1_FORNECE!='000010' OR A.D1_EMISSAO < @DTINI OR A.D1_CF = '1949')
GROUP BY D1_COD

union all

-- NOTAS DE DEVOLUCAO
SELECT 'SD1' ORIGEM,D1_COD,SUM(D1_CUSTO) CUSTO, SUM(D1_QUANT) QTD
FROM SD1010 A (NOLOCK) 
INNER JOIN SF4010 B ON B.D_E_L_E_T_='' AND B.F4_CODIGO=A.D1_TES AND B.F4_ESTOQUE='S'
INNER JOIN SF2010 C ON C.D_E_L_E_T_='' AND C.F2_FILIAL=A.D1_FILIAL AND C.F2_DOC=A.D1_NFORI AND C.F2_SERIE=A.D1_SERIORI
WHERE	A.D_E_L_E_T_=''
		AND A.D1_DTDIGIT BETWEEN @DTINI AND @DTFIM
		AND A.D1_TIPO = 'D'
		AND A.D1_TES!=''
		AND A.D1_TES!='207'
		AND CHARINDEX(RTRIM(A.D1_COD),@COD) > 0
		AND C.F2_EMISSAO < @DTINI
GROUP BY D1_COD

UNION ALL
--NOTAS DE BENEFICIAMENTO
SELECT 'SD1' ORIGEM,D1_COD,SUM(D1_CUSTO) CUSTO, SUM(D1_QUANT) QTD
FROM SD1010 A (NOLOCK) 
INNER JOIN SF4010 B ON B.D_E_L_E_T_='' AND B.F4_CODIGO=A.D1_TES AND B.F4_ESTOQUE='S'
INNER JOIN SF2010 C ON C.D_E_L_E_T_='' AND C.F2_FILIAL=A.D1_FILIAL AND C.F2_DOC=A.D1_NFORI AND C.F2_SERIE=A.D1_SERIORI
WHERE	A.D_E_L_E_T_=''
		AND A.D1_DTDIGIT BETWEEN @DTINI AND @DTFIM
		AND A.D1_TIPO = 'B'
		AND A.D1_TES!=''
		AND CHARINDEX(RTRIM(A.D1_COD),@COD) > 0
		AND C.F2_EMISSAO < @DTINI
GROUP BY D1_COD
-- SALDO INICIAL

union all
SELECT 'SB9' ORIGEM,B9_COD D1_COD,SUM(B9_VINI1) CUSTO, SUM(B9_QINI) QTD
FROM SB9010 A (NOLOCK)
WHERE	A.D_E_L_E_T_=''
		AND A.B9_DATA = @FECHA
		AND CHARINDEX(RTRIM(A.B9_COD),@COD)>0
		AND A.B9_QINI>0
GROUP BY B9_COD

union all

SELECT 'SD3E' ORIGEM,D3_COD D1_COD,SUM(D3_CUSTO1) CUSTO, SUM(D3_QUANT) QTD
FROM SD3010 A (NOLOCK)
WHERE	A.D_E_L_E_T_=''
		AND A.D3_EMISSAO BETWEEN @DTINI AND @DTFIM
		AND CHARINDEX(RTRIM(A.D3_COD),@COD)>0
		AND A.D3_TM<'499'
		AND A.D3_ESTORNO=''
GROUP BY D3_COD
union all
SELECT 'SD3S' ORIGEM,D3_COD D1_COD,SUM(D3_CUSTO1)*(-1) CUSTO, SUM(D3_QUANT)*(-1) QTD
FROM SD3010 A (NOLOCK)
WHERE	A.D_E_L_E_T_=''
		AND A.D3_EMISSAO BETWEEN @DTINI AND @DTFIM
		AND CHARINDEX(RTRIM(A.D3_COD),@COD)>0
		AND A.D3_QUANT=0
		AND A.D3_ESTORNO=''
		AND A.D3_TM BETWEEN '500' AND '998'
GROUP BY D3_COD
union all
SELECT 'SD2' ORIGEM,D3_COD D1_COD,SUM(D3_CUSTO1)*(-1) CUSTO, SUM(D3_QUANT)*(-1) QTD
FROM SD3010 A (NOLOCK)
WHERE	A.D_E_L_E_T_=''
		AND A.D3_EMISSAO BETWEEN @DTINI AND @DTFIM
		AND CHARINDEX(RTRIM(A.D3_COD),@COD)>0
		AND A.D3_ESTORNO=''
		AND A.D3_QUANT!=0
		AND A.D3_TM = '700'
GROUP BY D3_COD
union all
-- NOTAS DE DEVOLUCAO
SELECT 'SD2' ORIGEM,D2_COD,SUM(D2_CUSTO1)*(-1) CUSTO, SUM(D2_QUANT)*(-1) QTD
FROM SD2010 A (NOLOCK) 
INNER JOIN SF4010 B ON B.D_E_L_E_T_='' AND B.F4_CODIGO=A.D2_TES AND B.F4_ESTOQUE='S'
WHERE	A.D_E_L_E_T_=''
		AND A.D2_EMISSAO BETWEEN @DTINI AND @DTFIM
		AND A.D2_TIPO = 'D'
		AND CHARINDEX(RTRIM(A.D2_COD),@COD) > 0
GROUP BY D2_COD
) AS T1

GROUP BY D1_COD

ORDER BY 1

