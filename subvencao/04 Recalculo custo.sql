DECLARE @COD VARCHAR(MAX);
DECLARE @DTINI VARCHAR(8);
DECLARE @DTFIM VARCHAR(8);
DECLARE @FECHA VARCHAR(8);

-- SET @COD = N'024378,024379,024380,024381,024382,024384,024385,024386,024387,024388,024389,024390,024391,024392,024393,024394,024395,024428,024430,024434,024436,024438,024439,024444,024447,024448,024449,024450,024452,024453,024454,024457,024459,024460,024461,024462,024463,024475,024479,024483,024485,024486,024491,024494,024495,024508,024509,024521,024540,024541,024542,024543,024544,024545,024548,024558,024559,024569,024570,024576,024577,024578,024579,024585,024591,024592,024593,024595,024596,024597,024598,024599,024600,024605,024606,024607,024612,024615,024616,024619,024623,024624,024625,024627,024628,024629,024631,024632,024634,024635,024640,024687,024688,024691,024703,024705,024707,024708,024724,024725,024726,024741,024742,024743,024745,024747,024749,024759,024760,024761,024762,024768,024770,024772,024775,024776,024777,024778,024781,024782,024853,024870,024875,024881,024884,024886,024887,024888,024890,024892,024896,024897,024898,024901,024903,024904,024905,024906,024912,024915,024918,024919,024923,024924,024927,024928,024938,024941,024942,024951,024955,024964,024973,024975,024977,024980,024981,024983,024984,024985,024987,024989,024990,024993,024994,025003,025006,025015,025088,025120,025121,025138,025168,025241,025246,025247,025259,025294,025301,025358,025386,025415,025422,025423,025425,025444,025447,025452,025460,025473,025480,025482,025492,025493,025500,025504,025517,025519,025550,025551,025562,025563,025564,025568,025590,025616,025617,025618,025748,025754,025755,025793,025794,025812,025825,025826,025827,025828,025829,025853,025872,025873,025874,025875,025876,025877,025878,025881,025882,026065,026068,026072,026073,026076,026084,026085,026086,026087,026088,026089,026090,026091,026092,026093,026120,026122,026123,026124,026125,026126,026127,026139,026143,026145,026178,026190,026193,026195,026196,026232,026251,026264,026265,026268,026272,026273,026275,026276,026277,026278,026279,026280,026306,026309,026311,026320,026322,026324,026326,026327,026328,026330,026331,026333,026334,026335,026336,026337,026338,026339,026349,026356,026361,026365,026367,026370,026371,026375,026383,026388,026389,026397,026400,026403,026406,026434,026442,026459,026466,026469,026473,026474,026476,026482,026483,026484,026486,026488,026489,026490,026493,026516,026517,026518,026519,026532,026536,026537,026538,026543,026544,026546,026547,026548,026557,026558,026559,026561,026562,026563,026564,026565,026566,026569,026570,026571,026572,026574,026575,026578,026582,026587,026588,026590,026597,026684,026685,026686,026687,026688,026694,026695,026696,026697,026698,026700,026701,026702,026703,026704,026707,026708,026717,026719,026721,026730,026734,026735,026742,026743,026744,026745,026746,026747,026757,026761,026765,026766,026768,026770,026772,026773,026774,026777,026780,026781,026785,026790,026792,026797,026798,026804,026811,026812,026813,026816,026817,026818,026830,026831,026832,026833,026834,026853,026854,026855,026867,026908,026909,026914,026926,026940,026961,026974,026975,026977,026986,026996,026998,027005,027011,027013,027023,027026,027036,027038,027039,027046,027050,027051,027052,027063,027064,027074,027076,027077,027078,027079,027081,027083,027084,027085,027101,027102,027103,027104,027105,027106,027109,027110,027112,027113,027114,027115,027126,027130,027131,027132,027134,027135,027147,027150,027151,027155,027157,027161,027162,027163,027176,027177,027180,027182,027184,027185,027187,027188,027196,027197,027199,027219,027221,027222,027223,027224,027228,027229,027231,027232,027233,027235,027236,027241,027242,027243,027244,027245,027246,027247,027248,027250,027251,027252,027253,027254,027255,027256,027257,027259,027262,027271,027273,027274,027275,027276,027281,027282,027283,027285,027286,027288,027289,027292,027293,027294,027296,027297,027298,027300,027303,027310,027312,027314,027332,027338,027340,027341,027342,027343,027344,027349,027350,027353,027361,027362,027376,027379,027386,027387,027392,027400,027403,027404,027405,027419,027420,027421,027422,027424,027426,027427,027428,027432,027434,027436,027437,027440,027441,027460,027462,027469,027473,027485,027495,027496,027503,027504,027505,027506,027508,027509,027510,027511,027512,027513,027514,027516,027517,027519,027520,027527,027560,027561,027563,027564,027565,027566,027567,027568,027569,027575,027577,027580,027581,027582,027585,027586,027589,027590,027594,027611,027612,027616,027626,027633,027634,027637,027653,027669,027697,027701,027704,027708,027711,027713,027716,027717,027722,027724,027743,027773,027774,027786,027788,027814,027817,027830,027833,027834,027940,027942,027943,027944,027945,027947,027949,027950,027951,027952,027953,027961,027962,027963,027964,027965,027966,027967,027978,027979,027980,027981,027982,027983,027984,027985,027986,027987,027988,028024,028025,028026,028027,028028,028029,028030,028031,028032,028033,028034,028036,028037,028038,028039,028043,028044,028046,028047,028051,028052,028053,028054,028055,028056,028057,028058,028059,028060,028063,028064,028067,028074,028081,028084,028085,028091,028092,028095,028096,028097,028098,028099,028111,028113,028120,028136,028137,028138,028142,028143,028144,028145,028146,028147,028151,028153,028154,028155,028156,028157,028158,028161,028162,028163,028164,028165,028169,028171,028172,028173,028175,028176,028177,028178,028179,028180,028183,028185,028188,028189,028190,028191,028192,028193,028195,028197,028200,028201,028202,028204,028205,028206,028207,028208,028209,028210,028211,028212,028214,028216,028217,028218,028219,028220,028221,028222,028223,028229,028230,028231,028232,028233,028239,028245,028263,028266,028267,028268,028269,028277,028278,028279,028280,028314,028315,028316,028317,028318,028319,028321,028323,028326,028327,028329,028330,028338,028343,028345,028346,028348,028349,028351,028353,028355,028356,028359,028361,028363,028365,028367,028368,028371,028372,028373,028376,028379,028381,028383,028384,028386,028387,028389,028391,028392,028393,028394,028396,028397,028398,028399,028405,028410,028413,028414,028415,028423,028428,028432,028434,028435,028436,028437,028438,028439,028443,028444,028446,028453,028458,028459,028461,028463,028467,028490,028491,028492,028494,028517,028518,028519,028525,028527,028528,028529,028530,028531,028533,028535,028536,028539,028540,028543,028548,028549,028554,028557,028570,028571,028572,028573,028574,028575,028576,028578,028581,028582,028583,028584,028585,028589,028590,028591,028592,028593,028605,028610,028612,028618,028619,028620,028621,028622,028623,028624,028625,028627,028631,028632,028634,028665,028666,028667,028668,028670,028676,028679,028685,028686,028687,028688,028689,028690,028696,028709,028717,028718,028720,028722,028723,028724,028725,028726,028727,028728,028756,028766,028767,028768,028771,028822,028823,028824,028825,028826,028827,028828,028830,028833,028837,028842,028843,028844,028845,028846,028852,028857,028872,028881,028883,028885,028886,028897,028899,028904,028931,028932,028933,028935,028937,028938,028940,028941,028943,028946,028947,028949,028950,028951,028953,028954,028955,028956,028958,028959,028960,028961,028962,028963,028964,028965,028966,028968,028969,028970,028974,028984,028985,028986,028987,028995,028996,028997,029001,029005,029006,029007,029008,029009,029010,029011,029012,029013,029015,029018,029019,029020,029021,029022,029023,029024,029025,029027,029028,029029,029030,029031,029033,029034,029035,029036,029039,029040,029041,029043,029044,029046,029047,029049,029052,029054,029061,029063,029064,029066,029067,029068,029073,029075,029077,029080,029081,029083,029087,029088,029089,029090,029091,029095,029096,029097,029098,029099,029103,029104,029105,029111,029129,029130,029131,029132,029133,029134,029135,029137,029143,029144,029147,029149,029150,029151,029153,029154,029159,029161,029162,029165,029166,029167,029168,029196,029197,029198,029208,029210,029214,029215,029217,029221,029222,029223,029224,029245,029258,029273,029274,029277,029287,029289,029299,029300,029306,029333,029335,029336,029337,029338,029339,029340,029342,029354,029357,029365,029366,029377,029378,029400,029403,029406,029419,029426,029432,029436,029441,029442,029444,029445,029446,029451,029452,029460,029461,029462,029470,029475,029476,029477,029482,029495,029497,029502,029503,029508,029510,029511,029512,029513,029516,029521,029522,029525,029527,029529,029531,029551,029552,029560,029566,029567,029568,029569,029570,029571,029573,029577,029579,029580,029581,029582,029586,029587,029588,029589,029590,029591,029592,029593,029594,029595,029596,029597,029598,029599,029600,029601,029602,029603,029604,029605,029606,029607,029608,029609,029611,029612,029633,029634,029635,029636,029637,029638,029645,029646,029647,029648,029649,029650,029692,029693,029694,029698,029699,029701,029702,029703,029704,029705,029706,029707,029708,029710,029711,029712,029713,029714,029715,029716,029718,029719,029720,029721,029722,029723,029724,029725,029726,029727,029728,029729,029730,029731,029732,029733,029734,029738,029740,029742,029743,029744,029745,029746,029755,029758,029759,029761,029762,029764,029765,029766,029767,029769,029770,029780,029781,029782,029783,029861,029885,029891,029901,029902,029910,029911,029912,029913,029923,029924,029925,029927,029928,029929,029930,029950,029955,029958,029959,029963,029964,029965,029968,029969,029971,029972,029973,029974,029976,029977,029978,029979,029989,029990,029991,029992,029993,030021,030034,030035,030037,030038,030039,030040,030041,030042,030045,030056,030057,030058,030059,030060,030061,030062,030064,030074,030075,030076,030077,030082,030083,030084,030085,030086,030087,030088,030089,030090,030091,030092,030093,030094,030095,030098,030101,030102,030103,030104,030105,030106,030107,030108,030109,030110,030112,030113,030114,030115,030116,030117,030124,030125,030139,030142,030143,030151,030152,030159,030160,030161,030163,030164,030165,030166,030167,030172,030174,030175,030176,030177,030178,030179,030180,030181,030183,030186,030188,030189,030191,030195,030196,030199,030200,030201,030204,030205,030206,030207,030208,030209,030210,030211,030212,030213,030224,030225,030226,030227,030228,030229,030230,030231,030232,030233,030236,030237,030238,030241,030242,030243,030247,030248,030250,030251,030252,030253,030254,030255,030256,030257,030260,030261,030262,030263,030264,030265,030266,030269,030270,030271,030272,030274,030275,030276,030277,030279,030340,030341,030342,030343,030391,030442,030443,030486,030504,030551,030556,030557,030558,030559,030562,030563,030566,030570,030572,030573,030575,030576,030577,030584,030586,030589,030593,030594,030596,030599,030600,030606,030608,030609,030613,030614,030616,030620,030621,030626,030627,030628,030633,030634,030635,030636,030638,030639,030640,030641,030642,030644,030645,030647,030653,030670,030688,030690,030709,030716,030733,030742,030746,030747,030761,030785,030801,030802,030804,030805,030806,030811,030817,030822,030823,030824,030851,030883,030888,030893,030896,030898,030903,030912,030919,030921,030923,030936,030939,030972,030983,030998,031013,031014,031015,031016,031017,031018,031019,031020,031021,031022,031023,031024,031028,031031,031039,031041,031045,031055,031059,031067,031068,031070,031071,031072,031073,031074,031075,031076,031077,031078,031079,031094,031098,031099,031115,031117,031118,031119,031121,031128,031129,031136,031138,031139,031141,031142,031143,031194,031196,031200,031201,031202,031203,031204,031205,031206,031221,031222,031227,031230,031236,031322,031344,031345,031352,031353,031354,031356,031358,031359,031360,031368,031369,031370,031371,031372,031373,031374,031377,031382,031383,031384,031386,031411,031412,031413,031414,031415,031416,031417,031418,031419,031421,031422,031423,031424,031425,031427,031428,031432,031433,031434,031435,031436,031437,031440,031441,031442,031443,031444,031445,031446,031447,031448,031449,031453,031454,031456,031463,031465,031468,031469,031472,031480,031482,031485,031487,031488,031492,031495,031497,031499,031501,031505,031514,031522,031523,031524,031525,031526,031530,031532,031533,031537,031538,031539,031541,031544,031546,031547,031548,031549,031550,031552,031553,031554,031555,031556,031563,031565,031570,031572,031575,031579,031580,031582,031590,031599,031601,031613,031617,031618,031620,031621,031623,031625,031626,031628,031629,031630,031631,031634,031636,031638,031640,031641,031642,031643,031644,031645,031648,031649,031650,031655,031657,031660,031666,031667,031668,031669,031671,031672,031684,031688,031690,031715,031719,031721,031722,031723,031724,031725,031726,031728,031729,031730,031731,031732,031735,031736,031739,031740,031741,031742,031743,031744,031745,031746,031747,031748,031749,031752,031753,031754,031755,031756,031757,031758,031759,031760,031761,031762,031764,031765,031766,031767,031768,031769,031770,031771,031772,031773,031774,031775,031776,031777,031778,031779,031780,031782,031784,031785,031786,031788,031789,031790,031792,031793,031794,031795,031796,031797,031798,031800,031801,031803,031804,031805,031806,031807,031808,031809,031810,031811,031812,031813,031814,031815,031816,031817,031818,031819,031820,031821,031822,031823,031824,031825,031826,031827,031828,031829,031830,031831,031832,031833,031834,031836,031838,031839,031840,031841,031842,031843,031844,031845,031846,031848,031849,031850,031852,031853,031854,031855,031856,031857,031858,031859,031860,031862,031863,031867,031868,031869,031870,031871,031872,031873,031874,031875,031876,031878,031879,031880,031881,031882,031884,031885,031886,031889,031890,031891,031892,031894,031895,031896,031897,031898,031899,031900,031903,031905,031907,031908,031913,031915,031919,031920,031922,031923,031925,031926,031927,031928,031929,031930,031931,031932,031934,031935,031936,031937,031938,031939,031941,031942,031945,031949,031950,031951,031952,031953,031954,031955,031956,031957,031958,031961,031975,031976,031977,031978,031979,031981,031982,031985,032007,032008,032009,032010,032011,032012,032013,032014,032015,032016,032017,032018,032019,032020,032022,032023,032024,032025,032026,032027,032028,032029,032030,032031,032032,032033,032034,032035,032036,032037,032038,032039,032040,032041,032042,032043,032045,032046,032048,032049,032053,032054,032055,032056,032058,032059,032060,032061,032062,032063,032064,032065,032067,032068,032069,032070,032073,032074,032075,032076,032077,032078,032079,032080,032081,032082,032083,032084,032086,032087,032088,032089,032090,032091,032092,032093,032094,032095,032100,032101,032103,032104,032114,032121,032122,032123,032124,032125,032126,032127,032129,032130,032131,032134,032138,032139,032140,032141,032142,032145,032148,032149,032150,032151,032152,032153,032154,032155,032156,032157,032158,032160,032161,032162,032164,032165,032166,032167,032168,032169,032170,032171,032172,032173,032174,032175,032176,032177,032178,032179,032180,032181,032182,032183,032184,032185,032186,032187,032188,032189,032190,032191,032192,032193,032194,032195,032196,032197,032198,032199,032200,032201,032202,032203,032204,032205,032206,032207,032208,032209,032210,032211,032212,032213,032214,032215,032216,032217,032218,032219,032220,032221,032222,032223,032224,032225,032226,032227,032228,032229,032230,032238,032240,032241,032242,032243,032244,032245,032255,032258,032260,032261,032262,032263,032264,032265,032266,032267,032269,032270,032272,032273,032276,032277,032278,032279,032280,032282,032283,032284,032285,032286,032288,032290,032292,032296,032297,032298,032300,032309,032311,032312,032313,032314,032319,032320,032321,032322,032323,032324,032325,032326,032327,032328,032329,032330,032331,032333,032334,032335,032338,032342,032345,032346,032347,032359,032367,032374,032377,032379,032380,032381,032382,032383,032388,032389,032390,032391,032393,032399,032400,032401,032402,032403,032404,032405,032406,032407,032409,032410,032411,032412,032413,032414,032416,032417,032419,032420,032421,032422,032423,032425,032426,032428,032430,032431,032432,032433,032434,032436,032438,032439,032440,032451,032452,032453,032454,032455,032458,032459,032460,032462,032463,032464,032466,032467,032470,032471,032473,032475,032476,032477,032478,032479,032480,032481,032482,032483,032490,032491,032494,032497,032498,032499,032500,032501,032502,032503,032504,032505,032506,032507,032508,032509,032514,032515,032516,032517,032518,032519,032521,032522,032523,032524,032525,032526,032527,032530,032531,032532,032533,032534,032536,032537,032538,032539,032540,032541,032542,032543,032546,032547,032548,032549,032551,032552,032554,032555,032556,032557,032558,032559,032564,032566,032567,032568,032569,032570,032571,032572,032573,032574,032575,032576,032580,032585,032586,032587,032588,032589,032591,032592,032593,032594,032606,032607,032608,032609,032611,032612,032613,032616,032626,032627,032628,032629,032630,032631,032632,032633,032636,032637,032638,032640,032641,032642,032643,032645,032646,032647,032648,032649,032650,032653,032654,032655,032656,032657,032658,032659,032660,032661,032663,032664,032666,032667,032668,032669,032670,032671,032673,032674,032675,032676,032677,032679,032680,032681,032682,032683,032684,032685,032690,032694,032698,032699,032701,032702,032703,032704,032705,032706,032707,032708,032709,032710,032712,032713,032714,032715,032716,032717,032718,032719,032720,032722,032723,032724,032732,032733,032735,032736,032737,032738,032739,032740,032741,032742,032743,032744,032745,032747,032748,032749,032751,032753,032755,032756,032757,032759,032760,032761,032762,032763,032764,032765,032766,032767,032768,032769,032770,032787,032788,032789,032790,032791,032792,032796,032798,032803,032805,032807,032815,032816,032817,032818,032819,032820,032821,032822,032823,032825,032826,032827,032828,032829,032830,032831,032832,032834,032835,032836,032837,032838,032839,032840,032841,032842,032844,032845,032846,032847,032848,032849,032850,032851,032852,032854,032855,032860,032861,032864,032865,032866,032867,032868,032869,032870,032871,032872,032873,032874,032875,032876,032881,032887,032888,032889,032890,032891,032892,032893,032894,032895,032896,032897,032900,032904,032905,032906,032910,032911,032913,032917,032918,032922,032923,032924,032926,032927,032928,032929,032932,032933,032934,032935,032936,032937,032938,032940,032941,032942,032943,032944,032946,032950,032952,032953,032954,032959,032960,032963,032970,032971,032973,032975,032977,032986,032989,032991,032992,032993,032997,033000,033010,033011,033012,033013,033014,033018,033020,033022,033024,033025,033026,033027,033028,033029,033030,033031,033032,033033,033035,033036,033037,033038,033039,033040,033041,033042,033043,033044,033045,033046,033047,033048,033049,033050,033052,033053,033054,033055,033056,033057,033058,033059,033061,033062,033063,033066,033067,033070,033071,033072,033073,033074,033075,033076,033077,033079,033080,033081,033083,033085,033086,033087,033088,033099,033100,033102,033104,033107,033108,033109,033110,033111,033112,033115,033116,033117,033118,033119,033120,033121,033122,033123,033127,033128,033134,033135,033139,033140,033141,033142,033143,033145,033148,033149,033152,033159,033160,033161,033162,033163,033164,033168,033191,033199,033202,033214,033237,033241,033248,033249,033253,033258,033260,033261,033262,033263,033264,033265,033267,033272,033277,033278,033279,033280,033281,033283,033284,033285,033286,033287,033311,033313,033314,033315,033316,033317,033318,033325,033376,033378,033389,033399,033403,033406,033407,033408,033409,033414,033416,033419,033420,033422,033424,033426,033439,033440,033441,033442,033446,033447,033450,033451,033453,033454,033457,033459,033460,033461,033462,033463,033464,033465,033466,033467,033468,033469,033470,033471,033472,033473,033474,033475,033479,033481,033482,033483,033487,033488,033490,033491,033492,033493,033494,033495,033496,033497,033498,033500,033502,033503,033505,033506,033507,033508,033509,033511,033513,033514,033515,033516,033517,033518,033519,033521,033522,033523,033524,033525,033527,033528,033529,033530,033531,033532,033533,033534,033535,033537,033538,033539,033540,033542,033543,033544,033545,033546,033547,033548,033549,033550,033551,033552,033553,033554,033555,033556,033557,033558,033559,033560,033561,033562,033563,033565,033566,033567,033569,033570,033571,033572,033573,033574,033575,033576,033577,033578,033579,033580,033581,033582,033583,033584,033585,033586,033587,033588,033589,033590,033591,033592,033593,033594,033596,033597,033599,033600,033601,033602,033603,033604,033605,033608,033616,033617,033618,033619,033620,033621,033622,033623,033624,033625,033626,033632,033634,033635,033636,033637,033638,033640,033641,033642,033643,033644,033645,033654,033655,033659,033661,033662,033665,033666,033667,033668,033669,033678,033679,033685,033687,033690,033692,033694,033695,033696,033697,033698,033699,033701,033702,033717,033719,033720,033721,033722,033723,033724,033725,033726,033728,033729,033731,033732,033733,033734,033735,033736,033737,033738,033740,033748,033750,033751,033752,033754,033756,033760,033761,033762,033763,033765,033766,033774,033775,033776,033778,033780,033783,033784,033785,033786,033787,033788,033793,033794,033802,033803,033804,033811,033852,033857,033859,033860,033861,033866,033867,033869,033882,033885,033886,033887,033888,033890,033892,033893,033894,033895,033896,033897,033898,033904,033905,033906,033907,033908,033910,033911,033912,033913,033914,033915,033923,033924,033925,033926,033927,033928,033929,033930,033932,033933,033934,033935,033936,033937,033939,033940,033941,033942,033943,033944,033945,033950,033951,033952,033953,033954,033956,033957,033958,033959,033961,033962,033963,033964,033965,033966,033968,033969,033970,033971,033972,033973,033976,033983,033989,033990,033991,033992,033993,033994,033996,033997,033998,034004,034005,034006,034007,034011,034017,034019,034022,034023,034024,034026,034027,034028,034030,034031,034033,034034,034037,034038,034040,034043,034057,034058,034059,034060,034062,034063,034064,034065,034066,034067,034068,034069,034070,034081,034082,034083,034090,034092,034094,034097,034101,034102,034103,034104,034105,034119,034120,034121,034128,034133,034136,034153,034158,034159,034165,034178,034179,034182,034185,034195,034198,034199,034233,034234,034237,034240,034252,034284,034285,034286,034287,034288,034291,034292,034293,034295,034296,034297,034298,034299,034300,034301,034302,034303,034304,034309,034312,034313,034314,034315,034316,034317,034318,034320,034321,034322,034323,034324,034325,034326,034328,034329,034330,034335,034336,034337,034338,034339,034341,034342,034343,034344,034345,034346,034347,034348,034349,034350,034351,034352,034356,034357,034358,034359,034360,034361,034363,034364,034365,034368,034371,034372,034373,034374,034375,034376,034379,034380,034381,034382,034383,034384,034385,034386,034387,034388,034389,034390,034391,034392,034393,034394,034395,034396,034397,034398,034399,034403,034404,034405,034406,034407,034408,034409,034410,034411,034412,034413,034414,034415,034418,034420,034421,034422,034426,034427,034428,034429,034430,034431,034432,034433,034434,034435,034446,034447,034448,034450,034455,034456,034458,034460,034462,034463,034464,034465,034467,034468,034469,034470,034471,034472,034473,034474,034476,034477,034478,034479,034480,034481,034482,034483,034484,034485,034486,034487,034488,034489,034490,034491,034492,034493,034496,034498,034499,034507,034509,034510,034512,034513,034514,034515,034516,034517,034518,034519,034520,034521,034526,034529,034532,034533,034534,034535,034537,034538,034539,034540,034541,034542,034543,034544,034545,034546,034547,034548,034549,034550,034551,034552,034553,034554,034555,034556,034557,034558,034559,034560,034561,034563,034564,034565,034566,034567,034570,034571,034572,034573,034574,034575,034576,034577,034578,034579,034580,034581,034583,034584,034586,034587,034588,034589,034590,034591,034592,034593,034594,034595,034597,034598,034605,034607,034608,034609,034610,034611,034612,034613,034614,034615,034616,034617,034618,034619,034622,034629,034630,034631,034632,034633,034634,034635,034636,034638,034639,034640,034641,034642,034643,034644,034645,034646,034647,034648,034668,034669,034670,034671,034672,034673,034674,034675,034676,034677,034678,034679,034680,034681,034682,034683,034684,034685,034686,034687,034688,034689,034690,034691,034692,034693,034694,034695,034696,034697,034698,034699,034700,034701,034703,034707,034708,034710,034711,034713,034714,034715,034719,034720,034722,034726,034727,034729,034733,034734,034735,034736,034737,034738,034739,034740,034741,034742,034743,034744,034745,034746,034747,034748,034749,034750,034751,034752,034753,034754,034756,034757,034759,034760,034761,034762,034763,034764,034765,034767,034768,034769,034771,034772,034773,034774,034776,034777,034778,034779,034780,034781,034782,034783,034784,034785,034786,034787,034788,034789,034790,034791,034792,034793,034794,034795,034796,034797,034798,034806,034807,034809,034810,034811,034812,034813,034814,034815,034816,034818,034819,034820,034821,034822,034823,034824,034825,034826,034827,034828,034829,034830,034831,034833,034835,034837,034838,034839,034840,034841,034842,034844,034847,034848,034849,034851,034852,034854,034865,034866,034878,034879,034880,034882,034884,034886,034908,034910,034911,034920,034925,034926,034927,034928,034929,034930,034931,034932,034933,034934,034935,034936,034937,034946,034947,034948,034959,034961,034962,034963,034964,034965,034966,034967,034968,034977,034978,034979,034980,034981,034982,034983,034984,034985,034986,034987,034988,034989,034990,034993,034994,034995,034996,034997,034999,035000,035001,035002,035003,035005,035006,035007,035008,035009,035010,035011,035012,035013,035014,035015,035016,035017,035018,035019,035020,035021,035022,035023,035024,035025,035026,035027,035028,035029,035030,035031,035032,035033,035034,035035,035037,035038,035039,035040,035041,035042,035043,035045,035046,035047,035048,035051,035052,035054,035073,035075,035076,035077,035079,035080,035081,035082,035083,035084,035085,035086,035087,035088,035089,035090,035091,035092,035093,035094,035095,035096,035097,035098,035099,035101,035102,035103,035104,035105,035106,035107,035108,035110,035111,035112,035113,035114,035115,035116,035119,035120,035122,035124,035125,035126,035127,035129,035131,035132,035133,035134,035135,035136,035139,035141,035142,035145,035146,035147,035148,035149,035150,035151,035152,035153,035154,035155,035156,035157,035158,035159,035160,035161,035162,035163,035164,035165,035166,035168,035169,035171,035172,035173,035174,035175,035176,035177,035178,035179,035180,035181,035182,035183,035184,035185,035186,035191,035192,035193,035194,035195,035196,035197,035198,035199,035200,035201,035203,035204,035205,035206,035208,035215,035222,035224,035225,035226,035227,035228,035229,035230,035231,035232,035233,035234,035236,035237,035238,035240,035241,035242,035243,035244,035245,035246,035247,035248,035249,035250,035251,035252,035253,035254,035255,035256,035259,035260,035261,035262,035263,035264,035266,035267,035268,035270,035271,035272,035273,035275,035276,035277,035278,035279,035280,035281,035283,035284,035286,035287,035288,035289,035290,035291,035292,035294,035300,035302,035303,035308,035309,035310,035311,035312,035313,035314,035315,035316,035317,035318,035319,035320,035321,035322,035323,035324,035325,035326,035327,035328,035329,035330,035331,035332,035333,035334,035335,035336,035337,035338,035339,035340,035341,035342,035343,035344,035345,035346,035347,035348,035349,035351,035353,035354,035358,035360,035361,035362,035363,035364,035365,035367,035368,035370,035372,035374,035375,035377,035378,035383,035384,035385,035386,035387,035388,035389,035390,035391,035392,035393,035394,035395,035396,035397,035398,035399,035400,035402,035404,035405,035406,035407,035408,035409,035410,035411,035412,035413,035414,035416,035417,035419,035420,035421,035422,035423,035424,035428,035431,035432,035433,035434,035435,035436,035437,035438,035439,035440,035441,035442,035444,035445,035446,035447,035448,035449,035450,035452,035454,035455,035458,035459,035460,035462,035463,035464,035465,035466,035468,035470,035472,035474,035475,035477,035478,035479,035480,035481,035482,035484,035485,035486,035487,035490,035491,035494,035497,035498,035499,035500,035501,035502,035503,035505,035506,035507,035508,035509,035511,035512,035513,035514,035515,035517,035519,035521,035524,035525,035526,035527,035528,035530,035537,035538,035539,035540,035541,035542,035543,035544,035545,035546,035547,035548,035549,035550,035551,035552,035553,035554,035555,035556,035557,035559,035560,035561,035562,035563,035564,035566,035574,035575,035577,035578,035580,035582,035583,035586,035587,035588,035589,035590,035592,035593,035594,035595,035596,035597,035598,035599,035600,035601,035602,035605,035607,035608,035609,035610,035611,035612,035613,035614,035615,035616,035617,035618,035619,035620,035621,035622,035623,035624,035625,035626,035627,035628,035629,035630,035631,035632,035633,035634,035636,035637,035638,035639,035640,035641,035642,035644,035645,035647,035649,035651,035652,035653,035654,035655,035656,035657,035658,035659,035660,035662,035663,035664,035665,035666,035667,035669,035670,035671,035672,035673,035674,035678,035679,035680,035681,035682,035683,035684,035685,035686,035687,035688,035692,035693,035695,035705,035707,035709,035710,035712,035717,035725,035727,035728,035731,035732,035733,035734,035737,035742,035743,035747,035750,035751,035754,035758,035759,035766,035767,035788,035790,035815,035817,035820,035821,035828,035829,035832,035841,035849,035855,035856,035858,035860,035861,035862,035864,035865,035867,035868,035869,035870,035871,035872,035873,035874,035875,035877,035878,035883,035884,035885,035886,035888,035889,035891,035892,035894,035896,035897,035901,035902,035903,035904,035908,035911,035912,035914,035915,035916,035917,035918,035919,035920,035921,035922,035924,035925,035927,035928,035929,035930,035931,035932,035933,035934,035935,035936,035937,035938,035942,035944,035945,035947,035949,035951,035952,035953,035954,035957,035959,035960,035962,035963,035964,035971,035972,035976,035977,035981,035983,035984,035986,035993,035994,035999,036000,036002,036013,036014,036015,036016,036018,036019,036020,036021,036022,036025,036026,036027,036028,036029,036032,036033,036034,036037,036040,036042,036043,036044,036045,036046,036051,036052,036053,036054,036055,036056,036057,036058,036059,036060,036066,036067,036068,036070,036071,036072,036073,036074,036076,036077,036080,036081,036082,036083,036089,036098,036099,036100,036101,036102,036103,036104,036106,036107,036108,036109,036110,036111,036112,036113,036115,036116,036117,036118,036119,036121,036122,036124,036127,036132,036133,036135,036153,036154,036155,036156,036157,036161,036162,036163,036164,036165,036166,036168,036169,036170,036171,036172,036173,036176,036177,036178,036179,036184,036186,036187,036189,036195,036200,036207,036208,036210,036211,036212,036213,036217,036218,036219,036220,036221,036224,036225,036226,036227,036228,036230,036232,036233,036234,036235,036236,036237,036238,036239,036240,036241,036242,036243,036244,036245,036246,036247,036248,036249,036250,036252,036254,036257,036258,036259,036262,036263,036265,036266,036267,036276,036282,036285,036286,036287,036288,036290,036291,036292,036296,036298,036299,036301,036302,036303,036308,036309,036316,036317,036322,036323,036331,036332,036333,036334,036339,036341,036346,036347,036350,036351,036354,036355,036369,036370,036374,036376,036383,036384,036385,036386,036391,036392,036411,036412,036415,036416,036434,036436,036437,036443,036444,036445,036446,036448,036449,036450,036451,036455,036456,036457,036459,036461,036462,036465,036466,036467,036470,036471,036472,036476,036477,036478,036479,036480,036481,036482,036483,036484,036486,036487,036488,036489,036490,036491,036492,036493,036500,036501,036502,036503,036505,036506,036507,036508,036511,036512,036513,036514,036515,036517,036520,036521,036523,036524,036525,036527,036531,036532,036533,036536,036537,036538,036539,036541,036542,036543,036545,036546,036547,036548,036549,036550,036551,036552,036553,036554,036555,036556,036557,036558,036559,036560,036562,036564,036565,036566,036567,036568,036569,036570,036571,036572,036573,036574,036575,036576,036577,036578,036579,036581,036584,036588,036589,036590,036591,036593,036595,036596,036598,036599,036600,036601,036602,036603,036604,036606,036609,036610,036611,036612,036614,036615,036617,036618,036620,036621,036622,036623,036624,036625,036626,036627,036632,036640,036641,036643,036645,036646,036649,036650,036651,036655,036660,036662,036663,036664,036667,036670,036671,036672,036673,036677,036678,036679,036680,036681,036682,036683,036684,036685,036686,036687,036688,036690,036691,036693,036694,036696,036698,036699,036700,036701,036702,036703,036704,036705,036706,036707,036708,036710,036711,036712,036713,036714,036715,036716,036717,036718,036719,036720,036721,036722,036723,036729,036730,036736,036740,036742,036743,036744,036745,036746,036747,036748,036749,036751,036752,036753,036754,036756,036757,036758,036759,036761,036762,036763,036764,036765,036766,036767,036768,036769,036770,036771,036772,036775,036776,036777,036781,036783,036784,036785,036786,036787,036788,036789,036790,036791,036792,036795,036796,036797,036798,036799,036800,036801,036802,036818,036825,036826,036827,036830,036831,036832,036833,036839,036843,036844,036845,036847,036848,036849,036850,036855,036857,036858,036859,036860,036861,036862,036863,036864,036865,036867,036868,036869,036870,036871,036872,036873,036874,036875,036876,036877,036878,036879,036880,036881,036882,036883,036884,036885,036886,036887,036888,036903,036904,036905,036949,036950,036951,036952,036955,036957,036958,036960,036961,036963,036964,036972,036973,036974,036976,036977,036985,036986,036987,036988,036989,036990,036991,036993,036995,036996,036998,037000,037001,037002,037003,037004,037005,037008,037009,037010,037011,037012,037013,037014,037015,037016,037017,037018,037019,037020,037021,037024,037025,037026,037028,037029,037030,037045,037048,037049,037050,037051,037052,037053,037054,037057,037058,037059,037061,037063,037064,037065,037066,037068,037069,037071,037072,037073,037074,037075,037076,037077,037078,037079,037080,037081,037082,037083,037084,037085,037086,037087,037088,037089,037090,037091,037092,037093,037094,037095,037096,037097,037098,037099,037100,037101,037102,037103,037104,037106,037107,037108,037109,037111,037112,037128,037129,037130,037131,037132,037133,037134,037135,037136,037138,037139,037146,037147,037148,037149,037151,037152,037153,037179,037180,037183,037200,037201,037202,037203,037205,037206,037207,037208,037210,037212,037214,037215,037216,037217,037218,037222,037223,037224,037226,037228,037229,037233,037234,037241,037243,037246,037249,037251,037253,037254,037255,037256,037257,037260,037268,037269,037271,037273,037277,037279,037287,037288,037289,037290,037292,037293,037295,037296,037297,037303,037307,037308,037309,037310,037312,037314,037315,037316,037317,037318,037319,037323,037325,037327,037332,037334,037337,037340,037350,037351,037352,037353,037354,037356,037357,037358,037359,037360,037361,037362,037363,037365,037366,037368,037369,037370,037371,037372,037373,037374,037375,037376,037377,037378,037379,037381,037382,037383,037385,037386,037387,037391,037393,037395,037399,037400,037403,037404,037408,037411,037412,037419,037420,037423,037427,037428,037431,037434,037435,037440,037442,037443,037444,037446,037448,037449,037452,037455,037456,037457,037461,037462,037466,037470,037472,037474,037475,037480,037485,037486,037489,037490,037492,037495,037496,037497,037498,037499,037502,037505,037506,037509,037511,037512,037513,037514,037516,037517,037520,037521,037522,037523,037536,037537,037538,037539,037540,037541,037542,037543,037544,037545,037547,037552,037553,037555,037557,037558,037559,037560,037561,037562,037563,037564,037566,037570,037571,037572,037573,037574,037576,037577,037578,037581,037582,037583,037584,037585,037586,037587,037588,037590,037591,037592,037593,037594,037595,037596,037597,037600,037601,037603,037604,037605,037607,037608,037609,037610,037611,037612,037613,037614,037615,037616,037617,037618,037645,037646,037647,037650,037652,037653,037654,037655,037657,037658,037659,037661,037662,037663,037665,037666,037667,037668,037669,037670,037671,037672,037673,037674,037675,037676,037677,037678,037679,037681,037682,037683,037684,037685,037686,037687,037688,037690,037692,037693,037694,037695,037697,037698,037699,037700,037701,037702,037703,037706,037708,037709,037711,037714,037715,037716,037717,037719,037734,037735,037737,037738,037740,037741,037743,037744,037745,037747,037750,037752,037754,037756,037757,037759,037761,037764,037766,037768,037769,037771,037772,037773,037774,037778,037787,037788,037789,037790,037792,037794,037795,037796,037797,037798,037799,037800,037802,037803,037805,037806,037807,037810,037814,037816,037817,037819,038004,038124,038125,038132,038141,038142,038143,038144,038145,038146,038147,038148,038151,038154,038222,038235,038237,038238,038239,038240,038241,038242,038243,038244,038245,038246,038247,038248,038249,038250,038251,038252,038253,038254,038255,038300,038304,038413,038415,038416,038417,038419'
SET @COD = N'036218                  '
SET @DTINI = '20200701'
SET @DTFIM = '20200731'
SET @FECHA = '20200630'

SELECT	D1_COD,
		IIF(SUM(QTD)>0
		   ,SUM(CUSTO)/SUM(QTD)
		   ,SUM(IIF(ORIGEM!='SD2',CUSTO,0))
		   		/SUM(IIF(ORIGEM!='SD2',QTD,0))
		   ) Medio,
		
		--  PARA ANALISE		
		--    SUM(IIF(ORIGEM!='SD2',CUSTO,0)),
		--    SUM(IIF(ORIGEM!='SD2',QTD,0)),
		
		(SELECT MAX(B9_VINI1/B9_QINI) FROM SB9010 A (NOLOCK) WHERE A.D_E_L_E_T_='' AND A.B9_COD=T1.D1_COD AND A.B9_QINI>0 AND A.B9_DATA=@DTFIM) CUSTO_FECHADO, 
		(SELECT MAX(B9_VINI1/B9_QINI) FROM SB9010 A (NOLOCK) WHERE A.D_E_L_E_T_='' AND A.B9_COD=T1.D1_COD AND A.B9_QINI>0 AND A.B9_DATA=@FECHA) CUSTO_INICIAL
FROM 
(
	-- NOTAS DE ENTRADA
	SELECT 'SD1' ORIGEM,D1_COD,SUM(D1_CUSTO) CUSTO, SUM(D1_QUANT) QTD
	FROM SD1010 A (NOLOCK) 
	INNER JOIN SF4010 B (NOLOCK) ON B.D_E_L_E_T_='' AND B.F4_CODIGO=A.D1_TES AND B.F4_ESTOQUE='S'
	WHERE	A.D_E_L_E_T_=''
			AND A.D1_DTDIGIT BETWEEN @DTINI AND @DTFIM
			AND A.D1_TIPO NOT IN ('B','D')
			AND A.D1_TES!=''
			AND CHARINDEX(RTRIM(A.D1_COD),@COD) > 0
			AND (A.D1_FORNECE!='000010' OR A.D1_EMISSAO < @DTINI OR A.D1_CF = '1949')
	GROUP BY D1_COD

	union all

	-- NOTAS DE DEVOLUCAO
	SELECT 'SD1' ORIGEM,D1_COD,SUM(D1_CUSTO) CUSTO, SUM(D1_QUANT) QTD
	FROM SD1010 A (NOLOCK) 
	INNER JOIN SF4010 B (NOLOCK) ON B.D_E_L_E_T_='' AND B.F4_CODIGO=A.D1_TES AND B.F4_ESTOQUE='S'
	INNER JOIN SF2010 C (NOLOCK) ON C.D_E_L_E_T_='' AND C.F2_FILIAL=A.D1_FILORI AND C.F2_DOC=A.D1_NFORI AND C.F2_SERIE=A.D1_SERIORI
	WHERE	A.D_E_L_E_T_=''
			AND A.D1_DTDIGIT BETWEEN @DTINI AND @DTFIM
			AND A.D1_TIPO = 'D'
			AND A.D1_TES!=''
			-- AND A.D1_TES!='207'
			AND CHARINDEX(RTRIM(A.D1_COD),@COD) > 0
			AND C.F2_EMISSAO < @DTINI
	GROUP BY D1_COD

	UNION ALL
	--NOTAS DE BENEFICIAMENTO
	SELECT 'SD1' ORIGEM,D1_COD,SUM(D1_CUSTO) CUSTO, SUM(D1_QUANT) QTD
	FROM SD1010 A (NOLOCK) 
	INNER JOIN SF4010 B (NOLOCK) ON B.D_E_L_E_T_='' AND B.F4_CODIGO=A.D1_TES AND B.F4_ESTOQUE='S'
	INNER JOIN SF2010 C (NOLOCK) ON C.D_E_L_E_T_='' AND C.F2_FILIAL=A.D1_FILIAL AND C.F2_DOC=A.D1_NFORI AND C.F2_SERIE=A.D1_SERIORI
	WHERE	A.D_E_L_E_T_=''
			AND A.D1_DTDIGIT BETWEEN @DTINI AND @DTFIM
			AND A.D1_TIPO = 'B'
			AND A.D1_TES!=''
			AND CHARINDEX(RTRIM(A.D1_COD),@COD) > 0
			AND C.F2_EMISSAO < @DTINI
	GROUP BY D1_COD
	-- SALDO INICIAL

	union all
	SELECT 'SB9' ORIGEM,B9_COD D1_COD,SUM(B9_VINI1) CUSTO, SUM(B9_QINI) QTD
	FROM SB9010 A (NOLOCK)
	WHERE	A.D_E_L_E_T_=''
			AND A.B9_DATA = @FECHA
			AND CHARINDEX(RTRIM(A.B9_COD),@COD)>0
			AND A.B9_QINI>0
	GROUP BY B9_COD

	union all

	SELECT 'SD3E' ORIGEM,D3_COD D1_COD,SUM(D3_CUSTO1) CUSTO, SUM(D3_QUANT) QTD
	FROM SD3010 A (NOLOCK)
	WHERE	A.D_E_L_E_T_=''
			AND A.D3_EMISSAO BETWEEN @DTINI AND @DTFIM
			AND CHARINDEX(RTRIM(A.D3_COD),@COD)>0
			AND A.D3_TM<'499'
			AND A.D3_ESTORNO=''
	GROUP BY D3_COD
	union all
	SELECT 'SD3S' ORIGEM,D3_COD D1_COD,SUM(D3_CUSTO1)*(-1) CUSTO, SUM(D3_QUANT)*(-1) QTD
	FROM SD3010 A (NOLOCK)
	WHERE	A.D_E_L_E_T_=''
			AND A.D3_EMISSAO BETWEEN @DTINI AND @DTFIM
			AND CHARINDEX(RTRIM(A.D3_COD),@COD)>0
			AND A.D3_QUANT=0
			AND A.D3_ESTORNO=''
			AND A.D3_TM BETWEEN '500' AND '998'
	GROUP BY D3_COD
	union all
	SELECT 'SD2' ORIGEM,D3_COD D1_COD,SUM(D3_CUSTO1)*(-1) CUSTO, SUM(D3_QUANT)*(-1) QTD
	FROM SD3010 A (NOLOCK)
	WHERE	A.D_E_L_E_T_=''
			AND A.D3_EMISSAO BETWEEN @DTINI AND @DTFIM
			AND CHARINDEX(RTRIM(A.D3_COD),@COD)>0
			AND A.D3_ESTORNO=''
			AND A.D3_QUANT!=0
			AND A.D3_TM = '700'
	GROUP BY D3_COD
	union all
	-- NOTAS DE DEVOLUCAO
	SELECT 'SD2' ORIGEM,D2_COD,SUM(D2_CUSTO1)*(-1) CUSTO, SUM(D2_QUANT)*(-1) QTD
	FROM SD2010 A (NOLOCK) 
	INNER JOIN SF4010 B (NOLOCK) ON B.D_E_L_E_T_='' AND B.F4_CODIGO=A.D2_TES AND B.F4_ESTOQUE='S'
	WHERE	A.D_E_L_E_T_=''
			AND A.D2_EMISSAO BETWEEN @DTINI AND @DTFIM
			AND A.D2_TIPO = 'D'
			AND CHARINDEX(RTRIM(A.D2_COD),@COD) > 0
	GROUP BY D2_COD

) AS T1

GROUP BY D1_COD

ORDER BY 1

